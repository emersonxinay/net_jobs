{% extends "base.html" %} {% block content %}
<div class="chat-container">
  <!-- Header del chat -->
  <div class="chat-header">
    <div class="chat-user-info">
      <div class="user-avatar">
        <i class="fas fa-user-circle"></i>
      </div>
      <div class="user-details">
        <h2>{{ chat_user.username }}</h2>
        {% if chat_user.job_title %}
        <span class="user-job">
          <i class="fas fa-briefcase"></i>
          {{ chat_user.job_title }}
        </span>
        {% else %}
        <span class="user-job">
          <i class="fas fa-briefcase"></i>
          No disponible
        </span>
        {% endif %}
      </div>
    </div>
    <a href="{{ url_for('dashboard') }}" class="back-button">
      <i class="fas fa-arrow-left"></i>
      <span>Volver</span>
    </a>
  </div>

  <!-- Área de mensajes -->
  <div class="messages-container" id="messages">
    {% for msg in messages %} {% if msg.sender_id == current_user.id %}
    <div class="message-wrapper outgoing">
      <div class="message">
        <div class="message-content">{{ msg.message }}</div>
        <div class="message-meta">
          <span class="message-time">
            <i class="far fa-clock"></i>
            {{ msg.timestamp.strftime('%H:%M') }}
          </span>
          <span class="message-status">
            <i class="fas fa-check-double"></i>
          </span>
        </div>
      </div>
    </div>
    {% else %}
    <div class="message-wrapper incoming">
      <div class="message">
        <div class="message-content">{{ msg.message }}</div>
        <div class="message-meta">
          <span class="message-time">
            <i class="far fa-clock"></i>
            {{ msg.timestamp.strftime('%H:%M') }}
          </span>
        </div>
      </div>
    </div>
    {% endif %} {% endfor %}
  </div>

  <!-- Área de entrada de mensaje -->
  <div class="message-input-container">
    <form
      id="message-form"
      action="{{ url_for('send_message', receiver_id=chat_user.id, job_id=job.id) }}"
      method="POST"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="input-wrapper">
        <textarea
          id="message"
          name="message"
          placeholder="Escribe tu mensaje..."
          required
          rows="1"
          onInput="this.parentNode.dataset.replicatedValue = this.value"
        ></textarea>
      </div>
      <button type="submit" class="send-button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- Scripts de Pusher -->
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<script>
  // Variables necesarias
  const currentUserId = {{ current_user.id }};
  const currentJobId = {{ job.id }};
  const otherUserId = {{ chat_user.id }};

  // Función para formatear la fecha
  function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('es-ES', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Función para agregar mensaje al chat
  function appendMessage(data, isLocalMessage = false) {
    // Si no es un mensaje local, verificar si ya existe
    if (!isLocalMessage) {
      const existingMessage = document.querySelector(`[data-message-id="${data.message_id}"]`);
      if (existingMessage) return; // No agregar si ya existe
    }

    const messagesContainer = document.getElementById('messages');
    const isOutgoing = data.sender_id === currentUserId;

    const messageHTML = `
      <div class="message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}"
           data-message-id="${data.message_id}">
        <div class="message">
          <div class="message-content">${data.message}</div>
          <div class="message-meta">
            <span class="message-time">
              <i class="far fa-clock"></i>
              ${formatDateTime(data.timestamp)}
            </span>
            ${isOutgoing ? '<span class="message-status"><i class="fas fa-check-double"></i></span>' : ''}
          </div>
        </div>
      </div>
    `;

    messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
    scrollToBottom();
  }

  // Inicializar Pusher
  const pusher = new Pusher('{{ config.PUSHER_KEY }}', {
    cluster: '{{ config.PUSHER_CLUSTER }}',
    encrypted: true,
    authEndpoint: '/pusher/auth'
  });

  // Suscribirse al canal privado
  const channel = pusher.subscribe(`private-chat-${currentUserId}`);

  // Manejar eventos de conexión
  pusher.connection.bind('connected', () => {
    console.log('Conectado a Pusher');
  });

  // Escuchar nuevos mensajes
  channel.bind('new_message', function(data) {
    console.log('Mensaje recibido:', data);
    if (data.job_id === currentJobId) {
      appendMessage(data);
    }
  });

  // Manejar envío del formulario
  document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('message');
    const message = messageInput.value.trim();

    if (message) {
      // Limpiar el input inmediatamente
      messageInput.value = '';

      fetch(this.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `message=${encodeURIComponent(message)}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        // El mensaje se mostrará a través del evento Pusher
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje');
        // Restaurar el mensaje en el input si hubo error
        messageInput.value = message;
      });
    }
  });

  // Función para scroll automático
  function scrollToBottom() {
    const messagesContainer = document.getElementById('messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Scroll al cargar la página
  scrollToBottom();

  // Marcar mensajes como leídos al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof markMessagesAsRead === 'function') {
      markMessagesAsRead(otherUserId, currentJobId);
    }
  });
</script>
{% endblock %}
